
# WebDAV configuration, expects an Alias /dav /my/path/to/files
# For troubleshooting define also a RewriteLog and RewriteLogLevel
# Also make sure that the path that dav is aliased to is allowed (test without dav config first)

# Using location to avoid host specific directive, might have drawbacks
    <Location /dav>
		Dav on
		# get rid of lots of subrequests that pollute the rewrite log (not sure if it works in Location)
		DirectoryIndex index.html
		# Indexes required for dav browsing (I think), FollowSymLinks for rewrite + alias (or so I understood error.log)
		Options Indexes FollowSymLinks

		# how to authenticate a user
		AuthType Basic
		AuthName "repos test multirepo"
		AuthUserFile @ServerRoot@/hosts/multirepo/admin/repos-users
		
		# Microsoft webdav client folder support fix; it strips trailing slashes
#		RewriteCond %{HTTP_USER_AGENT} ^Microsoft.*
		# not needed inside location #RewriteCond %{REQUEST_URI} ^/dav/(.*[^/])$
		# The current fix relies on knowing the local path, to identify directory without subrequests
		# REQUEST_URI is urldecoded; can be used to check local path
		#RewriteCond @ServerRoot@/hosts/multirepo/dav/%1 -d
#		RewriteCond %{REQUEST_FILENAME} -d
		# Change URI internally, redirect would not be followed
#		RewriteRule ^(.*)$ $1/
		# Makes an internal redirect to the local path, but the request still results in redirect
	</Location>

	<Location /dav/allusers>
		Require valid-user
	</Location>

	# 'user' section, access only folder==username	
	<Location /dav/user>
		Require valid-user
		
		RewriteEngine on
		RewriteCond %{REQUEST_URI} ^/dav/user/([^/]+)/.*$
		# REMOTE_USER would require LA-U to be non-empty if outside Location/Directory
		RewriteCond %{REMOTE_USER}#%1 !^([^#]+)#(\1)$
		RewriteRule .* - [F]
    </Location>
    
    # 'share' section, accesss only to subfolders with exact URL given
    <Location /dav/share>
    	RewriteEngine on
		RewriteCond %{REQUEST_URI} ^/dav/share/([^/]*)/?$
		RewriteCond %1 !^$
		RewriteCond %{REQUEST_FILENAME} !-d
		# Shares should be created with name that is last day it should exist + 10 chars random string
		RewriteCond %{REQUEST_METHOD}#%1 !^MKCOL#\d{8}-\w{10}$
		RewriteRule .* - [F]
		
		<LimitExcept GET OPTIONS>
			Require valid-user
		</LimitExcept>
    </Location>

    <Location /dav/public/>

		# Public writable and readable would be dangerous
		<LimitExcept GET OPTIONS>
			Require valid-user
		</LimitExcept>
	</Location>

    # public+share, don't require authentication for read access

	# Fix Windows WebDAV behavior for folder operations
	RewriteEngine on
	# WinXP client: Microsoft Data Access Internet Publishing Provider DAV
	RewriteCond %{HTTP_USER_AGENT} ^Microsoft.*
	RewriteCond %{REQUEST_URI} ^/dav/(.*[^/])$
	# REQUEST_URI is urldecoded; can be used to check local path
	# Must know what the alias maps to here, for performance I guess
	RewriteCond @ServerRoot@/hosts/multirepo/dav/files/%1 -d
	RewriteRule ^(.*)$ $1/ [PT]

