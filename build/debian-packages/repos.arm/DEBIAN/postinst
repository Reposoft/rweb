#!/bin/sh

# to install repos dependendice, you most likely need backports in /etc/apt/sources.list
#deb http://www.backports.org/debian sarge-backports main
# and you probably need to pin the newer subversion packages in /etc/apt/preferences
#Package: subversion
#Pin: release a=sarge-backports
#Pin-Priority: 999
#
#Package: libsvn0
#Pin: release a=sarge-backports
#Pin-Priority: 999
#
#Package: libapache2-svn
#Pin: release a=sarge-backports
#Pin-Priority: 999
 
set -e

PHPINI="/etc/php4/apache2/php.ini"

# check that magic quotes is off


# enable dav+svn apache modules

if [ ! -e /etc/apache2/mods-enabled/dav.load ]
then
 ln -s /etc/apache2/mods-available/dav.load /etc/apache2/mods-enabled/dav.load
fi

if [ ! -e /etc/apache2/mods-enabled/dav_fs.conf ]
then
 ln -s /etc/apache2/mods-available/dav_fs.conf /etc/apache2/mods-enabled/dav_fs.conf
fi

if [ ! -e /etc/apache2/mods-enabled/dav_fs.load ]
then
 ln -s /etc/apache2/mods-available/dav_fs.load /etc/apache2/mods-enabled/dav_fs.load
fi

if [ ! -e /etc/apache2/mods-enabled/dav_svn.conf ]
then
 ln -s /etc/apache2/mods-available/dav_svn.conf /etc/apache2/mods-enabled/dav_svn.conf 
fi

if [ ! -e /etc/apache2/mods-enabled/dav_svn.load ]
then
 ln -s /etc/apache2/mods-available/dav_svn.load /etc/apache2/mods-enabled/dav_svn.load 
fi

# headers needed for cache optimization
if [ ! -e /etc/apache2/mods-enabled/headers.load ]
then
 ln -s /etc/apache2/mods-available/headers.load /etc/apache2/mods-enabled/headers.load 
fi

# auth-pam needed to integrate account management
if [ ! -e /etc/apache2/mods-enabled/auth_pam.load ]
then
 ln -s /etc/apache2/mods-available/auth_pam.load /etc/apache2/mods-enabled/auth_pam.load 
fi

# proxy needed for ssl+virtual hosts
#if [ ! -e /etc/apache2/mods-enabled/proxy.load ]
# rewrite needed for mass virtual hosts
#if [ ! -e /etc/apache2/mods-enabled/rewrite.load ]


# set up subversion folder structure
sudo -u www-data svn --config-dir "/var/www/admin/svn-config-dir/" info
chmod -R a-w /var/www/admin/svn-config-dir/

svnadmin create /var/www/repo/
chown -R www-data /var/www/repo/

chown www-data /var/www/backup

# enable the repository in apache
ln -s /var/www/admin/data-repository.conf /etc/apache2/sites-enabled/

# after repos is installed the login file must be copied to server root
mv /var/www/html/index.html /var/www/html/start.html
cp /var/www/html/repos/_host/html/* /var/www/html/


echo "Restart apacke2"

# for libapache2-mod-auth-pam make sure www-data is in the shadow group
# (grep for something like shadow:x:42:www-data in /etc/group)

