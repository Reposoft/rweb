#!/bin/sh

set -e

if [ "$1" != "configure" ]; then
 exit 0
fi

ETCPHP="/etc/php5"

for SAPI in apache cgi cli apache2
do
 if [ -f $ETCPHP/$SAPI/php.ini ]
 then
  if grep -q eaccelerator.so $ETCPHP/$SAPI/php.ini
  then
   echo "Not updating $ETCPHP/$SAPI/php.ini, 'eaccelerator.so' alredy exists"
  else
   echo "Adding eaccelerator extension and configuration to $ETCPHP/$SAPI/php.ini"
   echo "" >> $ETCPHP/$SAPI/php.ini
   echo "; --- eaccelerator ----" >> $ETCPHP/$SAPI/php.ini
   echo "extension=\"eaccelerator.so\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.shm_size=\"16\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.cache_dir=\"/tmp/eaccelerator\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.enable=\"1\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.optimizer=\"1\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.check_mtime=\"1\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.debug=\"0\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.filter=\"\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.shm_max=\"0\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.shm_ttl=\"0\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.shm_prune_period=\"0\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.shm_only=\"0\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.compress=\"1\"" >> $ETCPHP/$SAPI/php.ini
   echo "eaccelerator.compress_level=\"9\"" >> $ETCPHP/$SAPI/php.ini
  fi
 fi
done

echo "Create /tmp/eaccelerator and chmod it 777"
mkdir /tmp/eaccelerator
chmod 0777 /tmp/eaccelerator

exit 0
