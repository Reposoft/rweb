<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>repos.se dateformat plugin test page</title>
<!-- the script, with a realistic url that can be used to find webappRoot -->
<script type="text/javascript" src="../../scripts/shared/repos.js"></script>
<!-- unit testing must be imported after Repos, so it can override functions -->
<script type="text/javascript" src="../unittest.js"></script>
<!-- dependencies -->
<script type="text/javascript" src="../lib/jquery/jquery.js"></script>
</head>

<body>
<h1>Repos shared script API</h1>
<ul>
<li><code>Repos.reportError(error)</code></li>
<li><code>Repos.addScript(srcFromWebappRoot)</code></li>
<li><code>Repos.addCss(srcFromWebappRoot)</code></li>
</ul>
<h2>unit tests</h2>
<p>The unit test library overrides Repos.reportError, so it can't be tested, but the surrounding functions can be.</p>
<script type="text/javascript">

function TestRepos() {
    
    this.setUp = function() {
    };

	this.testErrorToString = function() {
		e = 'abc';
		this.assertEquals('abc', Repos._errorToString(e));
	}
	
	this.testErrorToStringException = function() {
		e = new Error('abc');
		this.assertTrue(Repos._errorToString(e).length > 3);
	}

	this.testExceptionToString = function() {
		e = new Error('my bad');
		msg = Repos._exceptionToString(e);
		this.assertTrue(msg.indexOf('my bad')>=0, "Should contain the exception message");
	};

	this.testExceptionToStringContainsFilename = function() {
		e = new Error();
		msg = Repos._exceptionToString(e);
		this.assertTrue(msg.indexOf('/shared/')>=0, "Should contain the script URL");
	};
	
	this.testGenerateId = function() {
		id1 = Repos._generateId();
		id2 = Repos._generateId();
		this.assertTrue((''+id1) != (''+id2));
	}
	
	this.testAlertError = function() {
		Repos._alertError('this is a test error message');
	}
	
	this.testLogError = function() {
		Repos._logError('repos.js unit test message');
	}
	
	this.testGetWebapp = function() {
		// Firefox creates an absolute URL: this.assertEquals('../../', Repos.getWebapp());
		this.assertTrue(/\.\.\/\.\.\/|https?:\/\/.*\/.*\/$/.test(Repos.getWebapp()));
	}

	this.testAddCss = function() {
		var e = Repos.addCss('scripts/shared/othercss.css');
		this.assertEquals('object', typeof(e));
		this.assertEquals(document.getElementsByTagName('head')[0],e.parentNode);
	}
	
	this.testAddScript = function() {
		// see http://www.mail-archive.com/discuss@jquery.com/msg10900.html
		var loadEventHandler = function() {
			window.addScript1 = true;
			var p = document.createElement('p');
			p.innerHTML = 'Callback reports that the added script has loaded';
			document.getElementsByTagName('body')[0].appendChild(p);
			// test load again
			Repos.addScript('scripts/shared/otherscript.js', 
				function() { window.addScript11 = true; console.log('second addScript handled'); });
			if (window.addScript11) console.log('OK: second addScript handler was called synchronously');
		}
		var e = Repos.addScript('scripts/shared/otherscript.js', loadEventHandler);
		this.assertEquals('object', typeof(e));
		this.assertEquals(document.getElementsByTagName('head')[0],e.parentNode);
		// now add the script again and make sure the event is fired immediately
		this.assertTrue(typeof(window.addScript3)=='undefined');
		var handler3 = function() {
			console.log('OK: third addScript handler called');
			if (typeof(window.addScript1)=='undefined') {
				console.log('Failed: first load event has not fired yet');
			} else {
				window.addScript3 = true;
			}
		}
		Repos.addScript('scripts/shared/otherscript.js', handler3);
		this.assertTrue(typeof(window.addScript3)!='undefined');
		// TODO how do we do asynchronous asserts?
	}
	
	this.testAddScriptNonExisting = function() {
		// no warning will be given
		var e = Repos.addScript('scripts/shared/nonexisting.js');
		this.assertEquals('object', typeof(e));
	}
	
}

testrun(TestRepos);
</script>

</body>
</html>
