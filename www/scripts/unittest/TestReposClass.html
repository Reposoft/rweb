<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>head.js testcases</title>
<!--<link href="../../style/global.css" rel="stylesheet" type="text/css" />-->
<script type="text/javascript" src="../head.js"></script>
<script type="text/javascript" src="../lib/scriptaculous/unittest.js"></script>
</head>

<body>
<h1>Test head.js, the Repos class.</h1>

<div id="testlog"></div>

<script type="text/javascript">

var aFunctionCalled = false;
var	anAspectCalled = false;
function ClassOne(){}
ClassOne.prototype = {
	aFunction: function(myarg) {
		aFunctionCalled = myarg;
	}
}
function ClassTwo(){}
ClassTwo.prototype = {
	anAspect: function(myarg) {
		anAspectCalled = myarg;
		// don't return anything, because then the real function is not called
	},
	interruptingAspect: function(myarg) {
		anAspectCalled = myarg;
		return true;
	}
}

// save some of the page state as it is during page load
var _loaded = Repos.isPageLoaded();
var _prototype = Prototype;

// do require as a plugin wouls have done it: right when the script loads
Repos.require('unittest/resources/mytestlib.js');

// a flag that can be used form any testcase
var flag = false;
function flagTrue() {
	flag = true;
}
function dummy() {
}

// Test runner starts once the page has loaded (I think it does that anyway)
function afterLoad() {
new Test.Unit.Runner({

	setup: function() { with(this) {
		aFunctionCalled = false;
		anAspectCalled = false;
		flag = false;
	}},
	
	testBeforeLoad: function() { with(this) {
		assertEqual(false, _loaded, "Repos should know that page is not completely loaded yet");
	}},
	
	testProtypeImported: function() { with(this) {
		assertNotNull(_prototype, "The prototype library should be imported automatically");
	}},
	
	testWindowOnloadSet: function() { with(this) {
		assertEqual('function', typeof(window.onload), 'Body onload should call the second Repos initializer');
	}},

	testAfterLoad: function() { with(this) {
		assertEqual(true, Repos.isPageLoaded(), "Repos should know that page has loaded now");
	}},

	// check that the lib imported in head is present now
	testRequireBeforePageLoaded: function() { with(this) {
		assertEqual(false, MyTestlib == undefined, "Can not finde MyTestlib that was just included with require");
		var myTest = new MyTestlib('arg');
		assertEqual('arg', myTest.getInitarg(), "MyTestlib should have an instance varable value now");
	}},
	
	// test that the AOP functionality works, becuase it is required for proper body.onload handling
	testBeforeAdvice: function() { with(this) {
		var c1 = new ClassOne();
		var c2 = new ClassTwo();
		Repos.addBefore(c2.anAspect, ClassOne, 'aFunction');
		c1.aFunction('arg');
		assertEqual('arg', aFunctionCalled, 'original method should have been called after the Before advice, because the advice did not return anything');
		assertEqual('arg', anAspectCalled, 'AOP advice should have been called with the same argument');
	}},
	
	testBeforeAdviceInterrupt: function() { with(this) {
		var c1 = new ClassOne();
		var c2 = new ClassTwo();
		Repos.addBefore(c2.interruptingAspect, ClassOne, 'aFunction');
		c1.aFunction('arg');
		assertEqual(false, aFunctionCalled, 'original function should not have been called, because the aspect returned somethind');
		assertEqual('arg', anAspectCalled, 'AOP advice should have been called with the same argument');
	}},
	
	testBeforeReposFunction: function() { with(this) {
		assertEqual(false, flag, 'test logic error: flag should be false before test');
		Repos.addBefore(flagTrue, Repos, 'createElement');
		Repos.createElement("div");
		assertEqual(true, flag, 'before advice should have been called for this repos function');
	}},
	
	testBeforeNonexistingFunction: function() { with(this) {
		try {
			Repos.addBefore(flagTrue, ClassOne, 'methodThatDoseNotExist');
		} catch(err) {
			info("Correctly got the exception: " + err);
			pass();
			return;
		}
		fail('AOP method addBefore should throw exception if the original method does not exist');
	}},
	
	testEventObserveAspect: function() { with(this) {
		assertEqual(true, Repos.isPageLoaded(), "Page should have loaded, or else this test does not prove anything");
		Event.observe(window, 'load', flagTrue, false);
		var toBeLoaded = _repos_loadqueue.pop();
		_repos_loadqueue.push(dummy); // replace with something so that the queue logic is not confused
		assertEqual(flagTrue, toBeLoaded, "The onload method should have been added to the load queue");
	}},
	
	// check that the AOP things don't affect the original Prototype behaviour
	testAddAnyObserver: function() { with(this) {
		assertEqual(false, flag, 'test logic error: flag should be false before test');
		var e = document.getElementsByName('testelement')[0];
		Event.observe(e, 'focus', flagTrue, false);
		e.focus();
		assertEqual(true, flag, 'onfocus observer for the testelement should have been called');
	}},

	testRequire: function() { with(this) {
		Repos.require('lib/scriptaculous/unittest.js');
		var toBeLoaded = _repos_loadqueue.pop();
		_repos_loadqueue.push(dummy); // replace with something so that the queue logic is not confused
		assertEqual('lib/scriptaculous/unittest.js', toBeLoaded, "The script should have been added to the load queue");
	}},
	
	testRequirePlugin: function() { with(this) {
		Repos.requirePlugin('dateformat');
		var toBeLoaded = _repos_loadqueue.pop();
		_repos_loadqueue.push(dummy); // replace with something so that the queue logic is not confused
		assertEqual('plugins/dateformat/dateformat.js' + (Repos.dontCachePlugins ? '?'+Repos.dontCachePlugins : ''),
			toBeLoaded, "The script should have been added to the load queue");
	}},
	
	testLoadScript: function() { with(this) {
		// using addBefore to mock appendChild
		Repos.addBefore(flagTrue, Repos.documentHead, 'appendChild');
		Repos._loadScript('lib/scriptaculous/unittest.js');
		var wasloaded = _repos_loadedlibs.pop();
		assertEqual(true, flag, 'script should have been added to the dom');
		assertEqual('lib/scriptaculous/unittest.js', wasloaded, 'script URL should have been saved in the loadedlibs stack');
	}},
	
	testVerifyResourceUrl: function() { with(this) {
		var yes = Repos.verifyResourceUrl('lib/scriptaculous/unittest.js');
		assertEqual(true, yes, "Should see that resource lib/scriptaculous/unittest.js exists");
	}},
	
	testVerifyResourceUrlFail: function() { with(this) {
		var no = Repos.verifyResourceUrl('lib/resource/that/does/not/exist.js');
		assertEqual(false, no, "Not an existing resource: lib/resource/that/does/not/exist.js");
	}},	
	
	testVerifyResourceUrlPartent: function() { with(this) {
		var yes = Repos.verifyResourceUrl('../style/global.css');
		assertEqual(true, yes, "CSS resource in repos dir (../style/global.css) should also be ok.");
	}},

	// for copy-paste
	testTemplate: function() { with(this) {
	}},

	teardown: function() { with(this) {}}
}, { });
}

// use prototype to set body.onload
Event.observe(window, 'load', afterLoad, false);

</script>
<form id="testform">
<p><input id="testelement" name="testelement" type="text" value="testelement"/></p>
</form>
</body>
</html>
