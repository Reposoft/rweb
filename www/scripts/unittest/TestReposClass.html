<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>head.js testcases</title>
<link href="../../style/global.css" rel="stylesheet" type="text/css" />
<script type="text/javascript" src="../head.js"></script>
<script type="text/javascript" src="../lib/scriptaculous/unittest.js"></script>
</head>

<body>
<h1>Test head.js, the Repos class.</h1>

<div id="testlog"></div>

<script type="text/javascript">

var aFunctionCalled = false;
var	anAspectCalled = false;
function ClassOne(){}
ClassOne.prototype = {
	aFunction: function(myarg) {
		aFunctionCalled = myarg;
	}
}
function ClassTwo(){}
ClassTwo.prototype = {
	anAspect: function(myarg) {
		anAspectCalled = myarg;
		// don't return anything, because then the real function is not called
	}
}

// save some of the page state as it is during page load
var _loaded = Repos.isPageLoaded();
var _prototype = Prototype;

// do require as a plugin wouls have done it: right when the script loads
Repos.require('unittest/resources/mytestlib.js');

// a flag that can be used form any testcase
var flag = false;
function flagTrue() {
	flag = true;
}

// Test runner starts once the page has loaded (I think it does that anyway)
function afterLoad() {
new Test.Unit.Runner({

	setup: function() { with(this) {
		flag = false;
	}},
	
	testBeforeLoad: function() { with(this) {
		assertEqual(false, _loaded, "Repos should know that page is not completely loaded yet");
	}},
	
	testProtypeImported: function() { with(this) {
		assertNotNull(_prototype, "The prototype library should be imported automatically");
	}},
	
	testWindowOnloadSet: function() { with(this) {
		assertEqual('function', typeof(window.onload), 'Body onload should call the second Repos initializer');
	}},

	testAfterLoad: function() { with(this) {
		assertEqual(true, Repos.isPageLoaded(), "Repos should know that page has loaded now");
	}},

	// check that the lib imported in head is present now
	testRequireBeforePageLoaded: function() { with(this) {
		assertEqual(false, MyTestlib == undefined, "Can not finde MyTestlib that was just included with require");
		var myTest = new MyTestlib('arg');
		assertEqual('arg', myTest.getInitarg(), "MyTestlib should have an instance varable value now");
	}},
	
	// test that the AOP functionality works, becuase it is required for proper body.onload handling
	testBeforeAdvice: function() { with(this) {
		var c1 = new ClassOne();
		var c2 = new ClassTwo();
		Repos.addBefore(c2.anAspect, ClassOne, 'aFunction');
		c1.aFunction('arg');
		assertEqual('arg', aFunctionCalled, 'test logic error: fOne should have been called');
		assertEqual('arg', anAspectCalled, 'AOP Before advice was not effective');
	}},
	
	testBeforeReposFunction: function() { with(this) {
		assertEqual(false, flag, 'test logic error: flag should be false before test');
		Repos.addBefore(flagTrue, Repos, 'createElement');
		Repos.createElement("div");
		assertEqual(true, flag, 'before advice should have been called for this repos function');
	}},
	
	testEventObserveAspect: function() { with(this) {
		assertEqual(true, Repos.isPageLoaded(), "Page should have loaded, or else this test does not prove anything");
		var loaded = false;
		Event.observe(window, 'load', function() {alert('runs after page load too')}, false);
		//but there is a delay//assertEqual(true, loaded, "The onload from this script should be executed even if it is after page load");
	}},

	// for copy-paste
	testTemplate: function() { with(this) {
	}},

	teardown: function() { with(this) {}}
}, { });
}

// use prototype to set body.onload
Event.observe(window, 'load', afterLoad, false);

</script>

</body>
</html>
