<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>Upload to repos</title>
<!--{if $download}-->
<meta http-equiv="refresh" content="1;url={=$download}" />
<!--{/if}-->
<script type="text/javascript">
function autoFillFilename(path) {
	var pos = Math.max(path.lastIndexOf('/'), path.lastIndexOf('\\'));
	if (0 >= pos) return;
	var filename = path.substring(pos + 1);
<!--{if not $isfile}-->
	document.getElementsByName('name')[0].value = filename;
<!--{else}-->
	if (filename == document.getElementById('name').value) return;
	var m = filename.match(/-(\d+)\.?\w*$/);
	if (!m || 2 > m.length) return; 
	var rev = m[1];
	var button = document.getElementById('fromrev'+rev);
	if (!button) {
		alert('From the filename it looks like changes are based on revision '+rev+'. But there is no such revision. Please check that it is the same document.');
	} else {
		button.checked = "checked";
	}
<!--{/if}-->
}

function checkType() {
	var localFilename = $('#userfile').val();
	if ($('#name').val()) {
		var reposFilename = $('#name').val();
		var i = reposFilename.match(/\.(\w*$)/);
		if (!i) {
			var j = localFilename.match(/\.(\w*$)/);
			if (j) {
				var reposFilenameWithType = reposFilename + j[0];
				$('#name').val(reposFilenameWithType);
				return true;
			}
			return true;
		}
		return true;
	}
	return true;
}
</script>
<!--{$head}-->
</head>

<body>
<div id="commandbar">
<a id="repository" href="{=$repository}">return to repository</a>
<a id="edit" href="../?target={=$target}">edit</a>
</div>
<h1>Upload file</h1>
<!--{if $download}-->
<p>You should automatically get a <a href="{=$download}">download box</a>.
Save the file on your hard drive, edit, then upload the new version in the form below.</p>
<!--{/if}-->
<!--{if $isfile}-->
<p>As a new version of file <a class="file" href="../open/?target={=$target}">{=$target}</a>.</p>
<div class="details" title="{=$target}" style="display: none">
Current revision: <span class="revision"></span><br />
Last modified <span class="datetime"></span> by <span class="username"></span><br />
Filesize: <span class="filesize"></span><br />
</div>
<!-- fixed, but there is still an option to overwrite 
<div class="warning">
<p>File upload is a convenient feature, but not a real versioning operation.
It <em>will</em> overwrite the existing file,
unlike a versioning commit that would check for conflicts first.
Please check existing contents before uploading,
to make sure that your local changes are based on the newest version of the shared file.
</p>
</div>
 -->
<!--{else}-->
<p>As a new file in folder {=$target}</p>
<!--{/if}-->
<form action="./" method="post" enctype="multipart/form-data" name="formUpload" id="formUpload">
<fieldset>
  <legend>Upload to repos</legend>
  <input type="hidden" name="target" value="{=$target}"/>
  <input type="hidden" name="type" value="upload"/>
  <p>
    <label for="userfile">local file</label>
	<input type="hidden" name="MAX_FILE_SIZE" value="{=$maxfilesize}" />
    <input type="file" id="userfile" name="userfile" size="40" onchange="autoFillFilename(value)" class="required" tabindex="1" />
    <span class="note">Maximum file size 10MB</span>
  </p>
  <p>
    <label for="name">name in repository</label>
	 <!--{if $isfile}-->
    <input type="text" id="name" name="name" value="{=$target|getPathName}" disabled="disabled" size="40" />
    <!--{else}-->
	 <input type="text" id="name" name="name" size="40" onchange="checkType()" class="required" tabindex="2" />
	 <input type="hidden" id="create" name="create" value="yes"/>   
    <!--{/if}-->
  </p>
  <!--{if $isfile}-->
  <p title="the version of the file when it was downloaded">
    {=foreach from=$log key=r item=e name=log}
      {=if $smarty.foreach.log.first}
      <label for="fromrev{=$r}">based on version <span class="revision">{=$r}</span></label>
      <input id="fromrev{=$r}" type="radio" name="fromrev" value="{=$r}" checked="checked" />
      <span class="username">{=$e.user}</span> <span class="datetime">{=$e.date}T{=$e.time}{=$e.z}</span>
      <span>(this is the current version)</span><br />
      {=else}
      <label for="fromrev{=$r}">&nbsp;<span class="revision">{=$r}</span></label>
      <input id="fromrev{=$r}" type="radio" name="fromrev" value="{=$r}" />
      <span class="username">{=$e.user}</span> <span class="datetime">{=$e.date}T{=$e.time}{=$e.z}</span><br />
      {=/if}
    {=/foreach}
      <label for="fromrevHEAD">&nbsp;</label>
      <input id="fromrevHEAD" type="radio" name="fromrev" value="HEAD" />
      <span>Don't know. Just overwrite the current version.</span>
  </p>
  {=if $file,isLockedByThisUser}
  <p>
  	 <label for="unlock">unlock at commit</label>
  	 <input type="checkbox" id="unlock" name="unlock" checked="checked"/>
  	 <!-- if lock should be kept, file must be relocked with this comment -->
  	 <input type="hidden" id="lockcomment" name="lockcomment" value="{=$file,lockComment}"/>
  </p>
  {=/if}
  <!--{else}-->
  <!-- not implemented
  <p>
  	 <label for="needslock">should be locked before edit</label>
  	 <input type="checkbox" id="needslock" name="needslock"/>
  </p>
   -->
  <!--{/if}-->
  <p>
    <label for="message">history text</label>
    <textarea id="message" name="message" cols="40" rows="2" tabindex="3">{=$file,lockComment}</textarea>
  </p>
  <p>
    <label for="submit"></label>
    <input id="submit" type="submit" name="Submit" value="Upload" tabindex="4" />
  </p>
</fieldset>
</form>
</body>
</html>
