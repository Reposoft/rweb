<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
<title>repos: details plugin test page</title>

<meta name="repos-service" content="index/" />
<meta name="repos-target" content="/demoproject/trunk/public/" />

<script type="text/javascript" src="../../scripts/lib/jquery/jquery.js"></script>
<script type="text/javascript" src="../../scripts/reposapi/repos.js"></script>

<script type="text/javascript" src="../fileid/fileid.js"></script>
<script type="text/javascript" src="../dateformat/dateformat.js"></script>
<script type="text/javascript" src="../byteformat/byteformat.js"></script>

<script type="text/javascript" src="details.js"></script>

<script type="text/javascript" src="../../scripts/unittest/testwalk.js"></script>

<link rel="stylesheet" type="text/css" href="../../style/repository/repository.css"/>
</head>

<body>
<h1>Repos file details plugin</h1>
<p>Dynamically add file or folder details to page</p>
<h2>Single file example</h2>
<div class="details" title="/demoproject/trunk/public/xmlfile.xml">
<p>Name: <span class="filename"></span></p>
<p>Size: <span class="filesize"></span></p>
<p>Current revision: <span class="revision"></span></p>
<p>Last edited by: <span class="username"></span></p>
<p>Last edited: <span class="datetime"></span></p>
</div>
<p>TODO currenty this test page matches only repos service "index/"</p>

<h2>Directory listing example</h2>
<p>If the folder does not exist there should be an error message.</p>
<div class="repository">
<div id="commandbar"><span>a command</span></div>
<div class="row" id="row:website_"><span>website</span></div>
<div class="row" id="row:images_"><span>images</span></div>
<div class="row" id="row:xmlfile.xml"><span>xmlfile.xml</span></div>
<div class="row" id="row:locked-file.txt"><span>locked-file.txt</span></div>
</div>

<h2>unit tests</h2>
<script type="text/javascript">



</script>

<h3>old unit tests</h3>
<p>Note that this page uses AJAX, so it must run from a web server.</p>
<script type="text/javascript">

// inside scope for unit testing
var units = $.fn.reposDetails;

test('AddTags', function() {
	var e = document.createElement("div");
	units.details_addtags($(e));
	assert(1, $(e).find('.revision').size());
	assert(1, $(e).find('.datetime').size());
	assert(1, $(e).find('.username').size());
	assert(1, $(e).find('.filesize').size());
	assert(4, e.getElementsByTagName('span').length);
	assert('', e.getElementsByTagName('span')[0].innerHTML);
});

test('DetailsFile', function() {
	var xml = '<entry kind="file"><name>test.java</name><size>123</size><commit revision="18">'
		+ '<author>test</author><date>2006-12-06T12:00:00.123456Z</date></commit></entry>';
	var e = document.createElement("div");
	units.details_addtags($(e));
	
	ok(!units.details_isFolder(_stringToJqueryDom(xml)));
	units.details_write($(e), _stringToJqueryDom(xml));
	assert('test', $(e).find('.username').text());
	assert('123 B', $(e).find('.filesize').text());
	assert('' != $(e).find('.datetime').text());
	assert('18', $(e).find('.revision').text());
});

test('DetailsFolder', function() {
	var xml = _stringToJqueryDom('<entry kind="dir"><name>public</name><commit revision="123456789">'
		+ '<author>svensson</author><date>2006-12-06T16:07:24.885217Z</date></commit></entry>');
	ok(units.details_isFolder(xml));
	
	var e = document.createElement("div");
	units.details_addtags($(e));
	
	units.details_write($(e), xml);
	assert('svensson', $(e).find('.username').text());
	assert('', $(e).find('.filesize').text());
	ok('' != $(e).find('.datetime').text());
	assert('123456789', $(e).find('.revision').text());	
});

test('Noaccess', function() {
	var xml = _stringToJqueryDom('<entry kind="dir"><name>noaccess</name><commit revision="3"></commit></entry>');
	ok(units.details_isNoaccess(xml));
	
	// if a file or folder is neither read or write to the user, author and date of last commit is not available
	var e = document.createElement("div");
	units.details_addtags($(e));
	units.details_write($(e), xml);
	
	// revision number still available
	assert('3', $(e).find('.revision').text());
	
	// TODO What is the suitable behaviour for no access, remove classes? add 'noaccess' class?
	assert('(no access)', $(e).find('.username').text());
	assert('', $(e).find('.datetime').text());
});

test('IsLocked', function() {
	var list = '<entry kind="file"><name>lock.txt</name><size>5</size><commit revision="2"><author>test</author><date>2006-12-07T11:09:51.793505Z</date>'
		+ '</commit><lock><token>opaquelocktoken:05379644-11ad-0048-8fc4-f273201ea126</token>'
		+ '<owner>svensson</owner><comment>work work</comment><created>2006-12-07T11:09:52.294225Z</created></lock></entry>';
	var xml = _stringToJqueryDom(list);
	ok(units.details_isLocked(xml));
	ok(!units.details_isNoaccess(xml));
	
	var xml = _stringToJqueryDom('<entry kind="dir"><name>public</name><commit revision="123456789">'
		+ '<author>svensson</author><date>2006-12-06T16:07:24.885217Z</date></commit></entry>');
	ok(!units.details_isLocked(xml));
});

function _stringToJqueryDom(xml) {
	// trying to DOMify arbitrary xml using the innerHTML feature of browsers
	return $(document.createElement('div')).append(xml).children();
}

</script>

</body>
</html>
