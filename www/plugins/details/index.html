<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
<title>repos: details plugin test page</title>

<meta name="repos-service" content="index/" />
<meta name="repos-target" content="/demoproject/trunk/public/" />

<!-- plugins -->
<script type="text/javascript" src="../../scripts/lib/jquery/jquery.js"></script>
<script type="text/javascript" src="../../scripts/reposapi/repos.js"></script>
<script type="text/javascript" src="details.js"></script>
<!-- if the dateformat plugin is present, date output will be formatted -->
<script type="text/javascript" src="../dateformat/dateformat.js"></script>
<!-- requires the fileid plugin -->
<script type="text/javascript" src="../fileid/fileid.js"></script>
<!-- for unit testing -->
<script type="text/javascript" src="../../scripts/unittest.js"></script>
<!-- needs the repository css -->
<link rel="stylesheet" type="text/css" href="../../style/repository/repository.css"/>
</head>

<body>
<h1>Repos file details plugin</h1>
<p>Dynamically add file or folder details to page</p>
<h2>Single file example</h2>
<div class="details" title="/demoproject/trunk/public/xmlfile.xml">
<p>Name: <span class="filename"></span></p>
<p>Size: <span class="filesize"></span></p>
<p>Current revision: <span class="revision"></span></p>
<p>Last edited by: <span class="username"></span></p>
<p>Last edited: <span class="datetime"></span></p>
</div>
<p>TODO currenty this test page matches only repos service "index/"</p>

<h2>Directory listing example</h2>
<p>If the folder does not exist there should be an error message.</p>
<div class="repository">
<div id="commandbar"><span>a command</span></div>
<div class="row" id="row:website_"><span>website</span></div>
<div class="row" id="row:images_"><span>images</span></div>
<div class="row" id="row:xmlfile.xml"><span>xmlfile.xml</span></div>
<div class="row" id="row:locked-file.txt"><span>locked-file.txt</span></div>
</div>

<h2>unit tests</h2>
<p>Note that this page uses AJAX, so it must run from a web server.</p>
<script type="text/javascript">

function TestDetails() {
	this.name = 'TestDetails';
	
	this.setUp = function() {
	};
	
	this.testAddTags = function() {
		var e = document.createElement("div");
		details_addtags($(e));
		this.assertEquals(1, $(e).find('.revision').size());
		this.assertEquals(1, $(e).find('.datetime').size());
		this.assertEquals(1, $(e).find('.username').size());
		this.assertEquals(1, $(e).find('.filesize').size());
		this.assertEquals(4, e.getElementsByTagName('span').length);
		this.assertEquals('', e.getElementsByTagName('span')[0].innerHTML);
	};

	this.testDetailsFile = function() {
		var xml = '<entry kind="file"><name>test.java</name><size>123</size><commit revision="18">'
			+ '<author>test</author><date>2006-12-06T12:00:00.123456Z</date></commit></entry>';
		var e = document.createElement("div");
		details_addtags($(e));
		
		this.assertFalse(details_isFolder(_stringToJqueryDom(xml)));
		details_write($(e), _stringToJqueryDom(xml));
		this.assertEquals('test', $(e).find('.username').text());
		this.assertEquals('123 B', $(e).find('.filesize').text());
		this.assertTrue('' != $(e).find('.datetime').text());
		this.assertEquals('18', $(e).find('.revision').text());
	};
	
	this.testDetailsFolder = function() {
		var xml = _stringToJqueryDom('<entry kind="dir"><name>public</name><commit revision="123456789">'
			+ '<author>svensson</author><date>2006-12-06T16:07:24.885217Z</date></commit></entry>');
		this.assertTrue(details_isFolder(xml));
		
		var e = document.createElement("div");
		details_addtags($(e));
		
		details_write($(e), xml);
		this.assertEquals('svensson', $(e).find('.username').text());
		this.assertEquals('', $(e).find('.filesize').text());
		this.assertTrue('' != $(e).find('.datetime').text());
		this.assertEquals('123456789', $(e).find('.revision').text());	
	};
	
	this.testNoaccess = function() {
		var xml = _stringToJqueryDom('<entry kind="dir"><name>noaccess</name><commit revision="3"></commit></entry>');
		this.assertTrue(details_isNoaccess(xml));
		
		// if a file or folder is neither read or write to the user, author and date of last commit is not available
		var e = document.createElement("div");
		details_addtags($(e));
		details_write($(e), xml);
		
		// revision number still available
		this.assertEquals('3', $(e).find('.revision').text());
		
		// TODO What is the suitable behaviour for no access, remove classes? add 'noaccess' class?
		this.assertEquals('(no access)', $(e).find('.username').text());
		this.assertEquals('', $(e).find('.datetime').text());
			
	};
	
	this.testIsLocked = function() {
		var list = '<entry kind="file"><name>lock.txt</name><size>5</size><commit revision="2"><author>test</author><date>2006-12-07T11:09:51.793505Z</date>'
			+ '</commit><lock><token>opaquelocktoken:05379644-11ad-0048-8fc4-f273201ea126</token>'
			+ '<owner>svensson</owner><comment>work work</comment><created>2006-12-07T11:09:52.294225Z</created></lock></entry>';
		var xml = _stringToJqueryDom(list);
		this.assertTrue(details_isLocked(xml));
		this.assertFalse(details_isNoaccess(xml));
		
		var xml = _stringToJqueryDom('<entry kind="dir"><name>public</name><commit revision="123456789">'
			+ '<author>svensson</author><date>2006-12-06T16:07:24.885217Z</date></commit></entry>');
		this.assertFalse(details_isLocked(xml));
	};
	
	this.testFormatSizeBytes = function() {
		this.assertEquals('1 B', details_formatSize('1'));
		this.assertEquals('999 B', details_formatSize('999'));
	};

	this.testFormatSizeKb = function() {
		this.assertEquals('0.98 kB', details_formatSize('1000'));
		this.assertEquals('0.99 kB', details_formatSize('1009'));
		this.assertEquals('1.00 kB', details_formatSize('1029'));
		this.assertEquals('10.0 kB', details_formatSize('' + (1024 * 10 + 51)));
		this.assertEquals('99.9 kB', details_formatSize('' + (1024 * 100 - 52)));
		this.assertEquals('999 kB', details_formatSize('' + (1024 * 1000 - 513)));
	};
	
	this.testFormatSizeMb = function() {
		this.assertEquals('0.98 MB', details_formatSize('' + (1024 * 1000 - 512)));
		this.assertEquals('1.00 MB', details_formatSize('' + (1024 * 1024 + 511)));
		this.assertEquals('100 MB', details_formatSize('' + (1024 * 1024 * 100)));
		this.assertEquals('1000 MB', details_formatSize('' + (1024 * 1024 * 1000)));
	};
}

function _stringToJqueryDom(xml) {
	// trying to DOMify arbitrary xml using the innerHTML feature of browsers
	return $(document.createElement('div')).append(xml).children();
}

testrun(TestDetails);

</script>

</body>
</html>
