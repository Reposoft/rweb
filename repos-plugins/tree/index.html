<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Repos Tree</title>
<!-- <script type="text/javascript" src="jquery.js"></script> -->
<script type="text/javascript" src="/repos-web/scripts/head.js"></script>
<link rel="stylesheet" type="text/css" media="all" href="/repos-web/style/global.css" />
<link rel="stylesheet" type="text/css" media="all" href="/repos-web/style/repository/repository.css" />
<style type="text/css">
.details {
	display: none;
}
span.details { /* tag layout is slightly different from details plugin */
	margin: .4em;
}
ul, li {
	padding: 0px;
	margin: 0px;
}
li {
	list-style: none;
}
h1 .hostname {
	display: block;
	font-size: 82.5%;
}
</style>
<script type="text/javascript">
//<![CDATA[

// plugin, from stilbuero.de, can be simplified if only the jQuery.extend api is used
(function(jQuery) {
	jQuery.querystring = function(s) {
		var r = {};
	    var q = s.substring(s.indexOf('?') + 1); // remove everything up to the ?
	    q = q.replace(/\&$/, ''); // remove the trailing &
	    jQuery.each(q.split('&'), function() {
			var splitted = this.split('=');
			var key = splitted[0];
			var val = splitted[1];
			// convert numbers
			if (/^[0-9.]+$/.test(val)) val = parseFloat(val);
			// convert booleans
			if (val == 'true') val = true;
			if (val == 'false') val = false;
			// ignore empty values
			if (typeof val == 'number' || typeof val == 'boolean' || val.length > 0) r[key] = val;
	    });
		return r;
	};
	// the public api,might be possible to override standard extend with typeof (options) == 'string'
	jQuery.queryextend = function(settings,options) {
		options = jQuery.querystring(options);
		jQuery.extend(settings,options);
	};
})($);

// configuration
var settings = {
	web: '/repos-web/',
	menu: true,
	frame: false,
	sidebar: false, // autodetect?
	autoexpand: false,
	hostname: window.location.hostname,
	repository: '/data', // not nessecary when json url is repos-web, but used in menu
	target: '/demoproject/trunk/' // or... http://localhost/repos-web/open/start/?serv=json
};
$.queryextend(settings, window.location.search);
console.log(settings);

var json = settings.web+'open/json/'; // not using servicelayer
function expand(id,target) {
  var list = $('#'+id);
  var here = target;
  $.ajax({
    dataType: 'script',
    url: json+'?selector='+id+'&target='+encodeURI(here),
    success: function() {
		$('li.folder', list).each(function() {
			var a = $('a',this); // created by list script
			var target = here + a.text()+'/'; // update in closure for recursion
			var id = Math.random().toString().substr(2);
			$('<ul/>').attr('id',id).appendTo(this);
			a.one('mouseover',
				function() {
					$(this).parent().addClass('loading');
					expand(id,target);
				});
			if (settings.autoexpand) a.trigger('mouseover');
			if (settings.frame) a.attr('target',settings.frame);
		});
		list.parent().filter('li').addClass('folder-open').removeClass('loading');
    },
    error: function(req, textStatus, errorThrown) {
    	// assume it is because we got access denied
		list.parent().filter('li').addClass('folder-noaccess').removeClass('loading');
	}
  });
};
$().ready(function() {
	if (settings.sidebar || settings.menu) {
		$('#target').text(settings.target);
		if (settings.hostname) $('<span/>').addClass('hostname').text(settings.hostname).prependTo('h1');
	}
	if (!settings.menu) {
		$('body').css('margin-top','8px'); // http://www.w3.org/TR/CSS21/sample.html
		$('#commandbar, #footer').hide();
	}
	expand('root',settings.target);
	var c = $('<div/>').addClass('actions').insertBefore('#footer');
	reposTreeBrowse().appendTo('#commandbar');
	reposTreeShowDetails().appendTo('#commandbar');
	reposTreePrint().appendTo('#commandbar');
	reposTreeExpandAll().addClass('action').appendTo(c);
	reposTreeSidebar().addClass('action').appendTo(c);
});
function reposTreeBrowse() {
	return $('<a/>').attr('id','repository').attr('href','http://'+settings.hostname+settings.repository+settings.start).text('return to repository').appendTo('#commandbar');
};
function reposTreeSidebar() {
	var title = 'repos: ' + settings.hostname + ' ' + settings.target;
	var url = window.location.href.replace(/&?frame=_top/,'') + '&sidebar=true'; // FIXME, assumes query string
	if ($.browser.msie && $.browser.version > '6.0') {
		return $('<a/>').text('as sidebar')
			.target("_search").attr('href',window.location.href)
			.title('Requires "Enable websites to use search pane" in IE7 options'); // http://www.flickr.com/photos/programwitch/274804191/
	}
	if (window.sidebar && window.sidebar.addPanel) {
		return $('<a/>').attr('href','#').text('as sidebar').click(function() {
			window.sidebar.addPanel(title, url, '');
		});
	}
};
function reposTreePrint() {
	return $('<a/>').attr('href','#').text('print tree').click(function() {
		window.print();
	});
};
function reposTreeExpandAll() {
	return $('<a/>').attr('href','#').text('expand all').click(function() {
		settings.autoexpand = true;
		$('li.folder a').trigger('mouseover');
	});
};
function reposTreeShowDetails() {
	return $('<a/>').attr('id','showdetails').attr('href','#').text('show details').click(function() {
		$('.details').show();
	});
};
//]]>
</script>

</head>
<body>
<div id="commandbar">
</div>

<h1 id="target"></h1>
<ul id="root">
</ul>

<div id="footer"></div>
</body>
</html>