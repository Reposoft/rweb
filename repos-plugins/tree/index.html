<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Repos Tree</title>
<!-- <script type="text/javascript" src="jquery.js"></script> -->
<script type="text/javascript" src="/repos-web/scripts/head.js"></script>
<link rel="stylesheet" type="text/css" media="all" href="/repos-web/style/global.css" />
<link rel="stylesheet" type="text/css" media="all" href="/repos-web/style/repository/repository.css" />
<style type="text/css">
ul {
	padding-left: 1em;
}
.details {
	display: none;
}
li {
	list-style: none;
}
h1 .hostname {
	display: block;
	font-size: 82.5%;
}
</style>
<script type="text/javascript">
//<![CDATA[
var reposweb = '/repos-web/';
var settings = {
	autoexpand: false,
	hostname: window.location.hostname,
	repository: '/data', // not needed because we use /repos-web/, would be needed if we used servicelayer
	start: '/demoproject/trunk/' // or... http://localhost/repos-web/open/start/?serv=json
};
var json = reposweb+'open/json/'; // not using servicelayer
function expand(id,target) {
  var list = $('#'+id);
  var here = target;
  $.ajax({
    dataType: 'script',
    url: json+'?selector='+id+'&target='+encodeURI(here),
    success: function() {
		$('li.folder', list).each(function() {
			var a = $('a',this);
			var target = here + a.text()+'/'; // update in closure for recursion
			var id = Math.random().toString().substr(2);
			$('<ul/>').attr('id',id).appendTo(this);
			a.one('mouseover',
				function() {
					$(this).parent().addClass('loading');
					expand(id,target);
				});
			if (settings.autoexpand) a.trigger('mouseover');
		});
		list.parent().filter('li').addClass('folder-open').removeClass('loading');
    },
    error: function(req, textStatus, errorThrown) {
    	// assume it is because we got access denied
		list.parent().addClass('folder-noaccess').removeClass('loading');
	}
  });
};
$().ready(function() {
	$('#target').text(settings.start);
	expand('root',settings.start);
	// extras
	if (settings.hostname) {
		$('<span/>').addClass('hostname').text(settings.hostname).prependTo('h1');
	}
	reposTreeBrowse();
	reposTreeSidebar();
	reposTreePrint();
	reposTreeExpandAll();
	reposTreeShowDetails();
});
function reposTreeBrowse() {
	var a = $('<a>').attr('id','repository').attr('href','http://'+settings.hostname+settings.repository+settings.start).text('return to repository').appendTo('#commandbar');
};
function reposTreeSidebar() {
	if ($.browser.msie && $.browser.version > '6.0') {
		// TODO test
		var a = $('<a>').text('as sidebar').appendTo('#commandbar')
			.target("_search").attr('href',window.location.href)
			.title('Requires "Enable websites to use search pane" in IE7 options'); // http://www.flickr.com/photos/programwitch/274804191/
	}
	if (window.sidebar && window.sidebar.addPanel) {
		var a = $('<a>').attr('href','#').text('as sidebar').appendTo('#commandbar').click(function() {
			window.sidebar.addPanel(settings.hostname + ' ' + settings.start, window.location.href, '');
		});
	}
};
function reposTreePrint() {
	var a = $('<a>').attr('href','#').text('print tree').appendTo('#commandbar').click(function() {
		window.print();
	});
};
function reposTreeExpandAll() {
	var a = $('<a>').attr('href','#').text('expand all').appendTo('#commandbar').click(function() {
		settings.autoexpand = true;
		$('li.folder a').trigger('mouseover');
	});
};
function reposTreeShowDetails() {
	var a = $('<a>').attr('id','showdetails').attr('href','#').text('show details').appendTo('#commandbar').click(function() {
		$('.details').show();
	});
};
//]]>
</script>

</head>
<body>
<div id="commandbar">
</div>

<h1 id="target"></h1>
<ul id="root">
</ul>

</body>
</html>