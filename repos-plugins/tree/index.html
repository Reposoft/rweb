<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<title>Repos Tree</title>
<!-- <script type="text/javascript" src="jquery.js"></script> -->
<script type="text/javascript" src="/repos-web/scripts/head.js"></script>
<link rel="stylesheet" type="text/css" media="all" href="/repos-web/style/global.css" />
<link rel="stylesheet" type="text/css" media="all" href="/repos-web/style/repository/repository.css" />
<style type="text/css">
.details {
	display: none;
}
span.details { /* tag layout is slightly different from details plugin */
	margin: 0 0 0 1em;
}
ul, li {
	padding: 0px;
	margin: 0px;
}
li {
	list-style: none;
}
h1 .hostname {
	display: block;
	font-size: 82.5%;
}
/* currently global.css contains no extra styling of printouts */
@media print {
	a {
		color: black;
	}
	.action {
		display: none;
	}
	.folder, .file {
		background-image: none;
		padding-left: 0;
	}
	li.folder {
		list-style: disc;
	}
	li.file {
		list-style: circle;
	}
}
</style>
<script type="text/javascript">
//<![CDATA[

// plugin, from stilbuero.de, can be simplified if only the jQuery.extend api is used
(function(jQuery) {
	jQuery.querystring = function(s) {
		var r = {};
	    var q = s.substring(s.indexOf('?') + 1); // remove everything up to the ?
	    q = q.replace(/\&$/, ''); // remove the trailing &
	    jQuery.each(q.split('&'), function() {
			var splitted = this.split('=');
			var key = splitted[0];
			var val = splitted[1] || false;
			val = decodeURI(val);
			// convert numbers
			if (/^[0-9.]+$/.test(val)) val = parseFloat(val);
			// convert booleans
			if (val == 'true') val = true;
			if (val == 'false') val = false;
			// ignore empty values
			if (typeof val == 'number' || typeof val == 'boolean' || val.length > 0) r[key] = val;
	    });
		return r;
	};
	// the public api,might be possible to override standard extend with typeof (options) == 'string'
	jQuery.queryextend = function(settings,options) {
		options = jQuery.querystring(options);
		jQuery.extend(settings,options);
	};
})($);

// configuration
var settings = {
	web: '/repos-web/',
	menu: true,
	frame: false,
	sidebar: false, // autodetect?
	autoexpand: false,
	hostname: window.location.hostname,
	https: window.location.href.substr(0,6)=='https:',
	repository: '/data', // not nessecary when json url is repos-web, but used in menu
	target: '/demoproject/trunk/' // or... http://localhost/repos-web/open/start/?serv=json
};
$.queryextend(settings, window.location.search);

var json = settings.web+'open/json/'; // not using servicelayer
function expand(id,target) {
  var list = $('#'+id);
  var here = target;
  $.ajax({
    dataType: 'script',
    url: json+'?selector='+id+'&target='+encodeURI(here),
    success: function() {
		$('li.folder', list).each(function() {
			var a = $('a',this); // created by list script
			var target = here + a.text()+'/'; // update in closure for recursion
			var id = Math.random().toString().substr(2);
			$('<ul/>').attr('id',id).appendTo(this);
			a.one('mouseover',
				function() {
					$(this).parent().addClass('loading');
					expand(id,target);
				});
			if (settings.autoexpand) a.trigger('mouseover');
		});
		$('li a', list).each(function() {
			var a = $(this);
			if (settings.frame) a.attr('target',settings.frame);
			if ($.browser.msie && settings.sidebar) a.attr('target','_main');
			if (settings.https)	a.attr('href', a.attr('href').replace('http:','https:'));
		});
		list.parent().filter('li').addClass('folder-open').removeClass('loading');
		// TODO mark empty folders?
    },
    error: function(req, textStatus, errorThrown) {
    	// assume it is because we got access denied
		list.parent().filter('li').addClass('folder-noaccess').removeClass('loading');
	}
  });
};
$().ready(function() {
	if (settings.sidebar || settings.menu) {
		$('#target').text(settings.target);
		if (settings.hostname) $('<span/>').addClass('hostname').text(settings.hostname).prependTo('h1');
	}
	if (settings.sidebar || !settings.menu) {
		$('body').css('margin-top','8px'); // http://www.w3.org/TR/CSS21/sample.html
		$('#commandbar, #footer').hide();
	}
	expand('root',settings.target);
	var c = $('<div/>').addClass('actions').insertBefore('#footer');
	c.wrapAll($('<div/>').css({margin:10})); // workaround: can't get css margin to work
	reposTreeBrowse().appendTo('#commandbar');
	reposTreeShowDetails().appendTo('#commandbar');
	reposTreePrint().appendTo('#commandbar');
	reposTreeExpandAll().addClass('action').appendTo(c);
	reposTreeHideFiles().addClass('action').appendTo(c);
	if (!settings.sidebar) reposTreeSidebar().addClass('action').appendTo(c);
	if (!settings.sidebar && !settings.menu) reposTreeMaximize().addClass('action').appendTo(c);
});
function reposTreeBrowse() {
	return $('<a/>').attr('id','repository').attr('href','http://'+settings.hostname+settings.repository+settings.target).text('return to repository').appendTo('#commandbar');
};
function reposTreeSidebar() {
	var title = 'repos: ' + settings.hostname + ' ' + settings.target;
	var url = window.location.href;
	url = url.replace(/([?&])frame=_top&?/,'$1');
	url += url.indexOf('?')>0 ? '&' : '?';
	url += 'sidebar=true';
	if ($.browser.msie) {
		return $('<a/>').html('as&nbsp;sidebar')
			.attr('target','_search').attr('href',url)
			.attr('title','Requires "Enable websites to use search pane" in IE7 options');
	}
	if (window.sidebar && window.sidebar.addPanel) {
		return $('<a/>').attr('href','javascript:void(0)').html('as&nbsp;sidebar').click(function() {
			window.sidebar.addPanel(title, url, '');
		});
	}
	// use this?: http://www.howtocreate.co.uk/tutorials/jsexamples/createSidebar.php
	// see also: http://staff.oclc.org/~houghtoa/repository/articles/IEBrowserBarDetails/index.htm
	// http://www.flickr.com/photos/programwitch/274804191/
};
function reposTreePrint() {
	return $('<a/>').attr('href','javascript:void(0)').html('print&nbsp;tree').click(function() {
		window.print();
	});
};
function reposTreeExpandAll() {
	return $('<a/>').attr('href','javascript:void(0)').html('expand&nbsp;all').click(function() {
		settings.autoexpand = true;
		$('li.folder a').trigger('mouseover');
	});
};
function reposTreeShowDetails() {
	return $('<a/>').attr('id','showdetails').attr('href','javascript:void(0)').html('show&nbsp;details').click(function() {
		$('.details').show();
	});
};
// TODO refactor display options to set classes that allow custom css
// which is also valid for new tree entries
function reposTreeHideFiles() {
	return $('<a/>').attr('id','hidefiles').attr('href','javascript:void(0)').html('hide&nbsp;files').click(function() {
		$('.file').hide();
	});
};
function reposTreeMaximize() {
	var url = window.location.href;
	url = url.replace(/([?&])menu=\w+&?/,'$1');
	url = url.replace(/([?&])sidebar=true&?/,'$1');
	return $('<a/>').attr('id','hidefiles').attr('target','_top').attr('href',url).text('maximize');
};
//]]>
</script>

</head>
<body class="repos-tree">
<div id="commandbar">
</div>

<h1 id="target"></h1>
<ul id="root">
</ul>
<div id="footer"></div>
</body>
</html>
